<!-- e0b1b8e2-50a3-41bb-a68d-f15c61ad5698 d55a5c4e-98ed-47ae-8332-851de333bdf6 -->
# Complete VYBE-MCP Integration Plan

## Current Status

✅ **Already Implemented:**

- MCP server registration in [`src/vs/workbench/contrib/vybeChat/browser/contribution/vybeMcpServer.contribution.ts`](src/vs/workbench/contrib/vybeChat/browser/contribution/vybeMcpServer.contribution.ts)
- Environment variable passing (WORKSPACE_ROOT, SUPABASE_URL, SUPABASE_KEY, etc.)
- Server path configuration with defaults
- Tool auto-discovery via `McpLanguageModelToolContribution`

## Missing Components

### 1. Repo ID Generation Service

**File**: `src/vs/workbench/contrib/vybeChat/common/vybeMcpRepoIdService.ts`

Create a service that generates stable `repo_id` values from workspace roots. This is required by most VYBE-MCP cloud tools (e.g., `search_codebase`, `vybe_solve_task`).

**Implementation:**

- Use workspace folder URI to generate stable hash (similar to `getWorkspaceIdentifier` in `src/vs/platform/workspaces/node/workspaces.ts`)
- Cache repo_id per workspace
- Expose via `IVybeMcpRepoIdService` interface

**Usage:** Tools that need `repo_id` will call this service to get the current workspace's repo_id.

### 2. Session Management Integration

**File**: `src/vs/workbench/contrib/vybeChat/common/vybeMcpSessionService.ts`

Track MCP sessions and maintain continuity across chat interactions. The `vybe_session_solve` tool requires `session_id` to maintain conversation context.

**Implementation:**

- Map IDE chat session IDs to MCP session IDs
- Store mapping in workspace storage
- Provide `getOrCreateMcpSessionId(chatSessionId: string): Promise<string>`
- Integrate with existing chat session management

**Integration Points:**

- Hook into `ChatModel` session creation
- Pass `session_id` when calling `vybe_session_solve` tool
- Use `list_sessions` and `get_session` tools to show session history

### 3. Event Streaming Client (SSE)

**File**: `src/vs/workbench/contrib/vybeChat/common/vybeMcpEventStreamService.ts`

Implement SSE client for real-time task progress updates from the `subscribe_events` tool.

**Implementation:**

- Create `EventSource` connection to MCP server SSE endpoint
- Parse and emit events: `agent_step_start`, `agent_step_complete`, `task_complete`, `patch_generated`, `test_result`
- Integrate with chat UI to show progress indicators
- Handle connection lifecycle (connect on task start, disconnect on completion)

**Event Types to Handle:**

- `agent_step_start` / `agent_step_complete` - Show agent progress
- `task_complete` / `task_failed` - Task completion status
- `patch_generated` - New patch available for approval
- `test_result` - Test execution results

### 4. Panel Envelope Renderer

**Files**:

- `src/vs/workbench/contrib/vybeChat/browser/contentParts/vybeChatPanelEnvelopePart.ts`
- `src/vs/workbench/contrib/vybeChat/browser/components/panelEnvelope/panelEnvelopeRenderer.ts`

Render Panel Envelope responses from `vybe_solve_task` and `vybe_session_solve` tools. The envelope contains patches, test results, and metadata.

**Components to Build:**

- **Patch Viewer**: Display pending/applied patches in diff view
- **Test Results Display**: Show test execution output
- **Metadata Panel**: Display execution stats (files touched, patches generated, etc.)
- **Approval UI**: Buttons to approve/reject pending patches

**Integration:**

- Detect Panel Envelope in tool results
- Create `VybeChatPanelEnvelopePart` content part
- Register in `VybeChatViewPane` content parts registry

### 5. Approval Workflow Integration

**File**: `src/vs/workbench/contrib/vybeChat/browser/components/panelEnvelope/patchApprovalWorkflow.ts`

Implement UI and logic for approving/rejecting patches generated by MCP tools.

**Implementation:**

- Show pending patches in diff view
- Provide approve/reject buttons
- Call `apply_patch` tool with approval when user accepts
- Track approval state per patch
- Show applied patches as completed changes

**Note:** The MCP server fixes mentioned in the analysis document should ensure proper approval gate enforcement.

### 6. Tool Parameter Injection

**File**: `src/vs/workbench/contrib/vybeChat/common/vybeMcpToolParameterInjector.ts`

Automatically inject `repo_id` and `session_id` into tool calls that require them, so the AI doesn't need to provide these parameters explicitly.

**Implementation:**

- Intercept tool invocations via `ILanguageModelToolsService`
- Detect tools that need `repo_id` or `session_id`
- Inject parameters before execution
- Use `IVybeMcpRepoIdService` and `IVybeMcpSessionService`

**Tools Requiring Injection:**

- `repo_id`: `search_codebase`, `vybe_solve_task`, `vybe_session_solve`, `get_context_for_task`, etc.
- `session_id`: `vybe_session_solve`, `get_session`, `list_session_entries`

## Implementation Order

1. **Repo ID Service** - Foundation for other features
2. **Session Management** - Enables session continuity
3. **Tool Parameter Injection** - Makes tools easier to use
4. **Panel Envelope Renderer** - Core UI for MCP results
5. **Approval Workflow** - Complete the patch workflow
6. **Event Streaming** - Real-time updates (can be done in parallel)

## Configuration

Add VS Code settings for:

- `vybe.mcp.repoId` - Override auto-generated repo_id (optional)
- `vybe.mcp.enableEventStreaming` - Toggle SSE updates (default: true)
- `vybe.mcp.autoApprovePatches` - Auto-approve patches (default: false)

## Testing Strategy

1. **Unit Tests**: Repo ID generation, session mapping
2. **Integration Tests**: Tool parameter injection, envelope parsing
3. **Manual Testing**: Full workflow from chat → tool call → envelope display → approval

## Files to Create

1. `src/vs/workbench/contrib/vybeChat/common/vybeMcpRepoIdService.ts`
2. `src/vs/workbench/contrib/vybeChat/common/vybeMcpSessionService.ts`
3. `src/vs/workbench/contrib/vybeChat/common/vybeMcpEventStreamService.ts`
4. `src/vs/workbench/contrib/vybeChat/common/vybeMcpToolParameterInjector.ts`
5. `src/vs/workbench/contrib/vybeChat/browser/contentParts/vybeChatPanelEnvelopePart.ts`
6. `src/vs/workbench/contrib/vybeChat/browser/components/panelEnvelope/panelEnvelopeRenderer.ts`
7. `src/vs/workbench/contrib/vybeChat/browser/components/panelEnvelope/patchApprovalWorkflow.ts`

## Files to Modify

1. `src/vs/workbench/contrib/vybeChat/browser/contribution/vybeChat.contribution.ts` - Register new services
2. `src/vs/workbench/contrib/vybeChat/browser/vybeChatViewPane.ts` - Register panel envelope content part
3. `src/vs/workbench/contrib/vybeChat/common/vybeChatService.ts` (if exists) - Integrate services

## Dependencies

- Existing MCP infrastructure (already in place)
- Chat session management (already exists)
- Workspace context service (already available)
- File service for storage (already available)